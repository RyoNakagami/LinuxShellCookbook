# `sed`コマンドを用いた文字列置換

**Table of Contents**
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [sed コマンド](#sed-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89)
  - [基本正規表現 (BRE) と拡張正規表現 (ERE)](#%E5%9F%BA%E6%9C%AC%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE-bre-%E3%81%A8%E6%8B%A1%E5%BC%B5%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE-ere)
- [sedコマンドでファイルを上書きしつつバックアップを残す方法](#sed%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%A7%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%B8%8A%E6%9B%B8%E3%81%8D%E3%81%97%E3%81%A4%E3%81%A4%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%82%92%E6%AE%8B%E3%81%99%E6%96%B9%E6%B3%95)
  - [バックアップファイルの内容を対応する既存ファイルに対応させる方法](#%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E5%86%85%E5%AE%B9%E3%82%92%E5%AF%BE%E5%BF%9C%E3%81%99%E3%82%8B%E6%97%A2%E5%AD%98%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AB%E5%AF%BE%E5%BF%9C%E3%81%95%E3%81%9B%E3%82%8B%E6%96%B9%E6%B3%95)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## sed コマンド

`sed`はStream EDitor」の略で、正規表現を使って文字列を置換するツールです. 

> Syntax

```zsh
% sed [オプション] <スクリプトコマンド> <入力ファイル>
```

文字列の置き換えは、`s/置換前/置換後/`で行います. 例えば、`s/jpg/jpeg/`で「jpg」を「jpeg」に置き換えることができます.

> Option一覧

|短いオプション |長いオプション |意味|
|---|---|---|
|`-r`, `-E`|`--regexp-extended`|スクリプトで拡張正規表現を使用する. `-E`の使用が推奨されている|
|`-e スクリプト`|`--expression=スクリプト`| スクリプト（コマンド）を追加する|
|`-f スクリプトファイル`|`--file=スクリプトファイル`|実行するコマンドとしてスクリプトファイルの内容を追加する|
|`-i`|`--in-place`|ファイルを直接編集する|
|`-i拡張子`|`--in-place=拡張子`|ファイルを直接編集し、指定した拡張子でバックアップする（※「-i」と「拡張子」の間には空白を入れない）|
|`-n`|`--quiet`,`--silent`| 力コマンド以外の出力を行わない（デフォルトでは処理しなかった行はそのまま出力される）|
|`-l 文字数`|`--line-length=文字数`|lコマンドの出力行を折り返す長さを指定する（※「-l」と「文字数」の間には空白を入れる）|
|`-s`|`--separate`|複数の入力ファイルを一続きのストリームとして扱わずに個別のファイルとして扱う|
|`-u`|`--unbuffered`|入力ファイルからデータをごく少量ずつ取り込み、頻繁に出力バッファを掃き出す|
|`-z`|`--null-data`|NUL文字で行を分割する（通常は改行で分割）|

### 基本正規表現 (BRE) と拡張正規表現 (ERE)

---|---
基本正規表現 (BRE)|(ピュアな)基本正規表現
拡張正規表現 (ERE)|`+`, `?`, `{n,m}`, `{n,}`, `{n}`, `(regexp)`, `|`といった正規表現演算子がエスケープ無しで使えます

> 例: BREとEREの差異

「クロロメチルエチルエーテル」という文字列を「クロロエチルメチルエーテル」に変える問題（`~/sh/00002_sed_replace_strings.sh`参照）を考えます.
下には、BREを用いてで記述する場合とEREを用いて記述する場合を紹介します.

```zsh
% echo クロロメチルエチルエーテル| sed -E 's/(メチル)(エチル)/\2\1/' 
% echo クロロメチルエチルエーテル| sed 's/\(メチル\)\(エチル\)/\2\1/' 
```

## sedコマンドでファイルを上書きしつつバックアップを残す方法

カレントディレクトリに`.sql`ファイルがたくさんあって、それらの `project-abc.dataset_xyz` を `project-def.dataset_pqr` に変更したいとします. ただし、変更前のファイル内容を全部バックアップを取りつつ上書き更新したいとします. このときのコマンドは以下のようになります:

```zsh
% sed -i".bak" 's/project-abc.dataset_xyz/project-def.dataset_pqr/g' ./*.sql
```

> .bakって？

BAKファイルとは、ファイルのバックアップを作成する際に作成される、拡張子に「`.bak`」が付いたファイルのことです. BAKファイルは特定のアプリケーションで開くようなファイルではく、拡張子は必ずしも「`.bak`」でなくてよいです. 慣習的に、多くのアプリケーションによって `.bak` が採用されています.

### バックアップファイルの内容を対応する既存ファイルに対応させる方法

`find`コマンドで対象ファイルを検索し、それをパイプと `xargs` を組合せて `cp` コマンドに渡すことで対応可能です. 

```zsh
% find ./*.sql|xargs -I cp {}{.bak,}  
```

上書きされるファイルについて、その可否を逐次確認したい場合は、オプション `-i` を `cp` コマンドに付与します (`find ./*.sql|xargs -I cp {}{.bak,}`). 